{% extends "improved_base.html" %}

{% block title %}Elite Athletes • Communication Hub{% endblock %}
{% block page_title %}Communication Hub{% endblock %}
{% block page_subtitle %}Centralise and respond to your athletes' messages{% endblock %}

{% block extra_css %}
<style>
/* Layout for communication hub with three columns */
.communication-hub {
    display: grid;
    grid-template-columns: 280px 1fr 320px;
    gap: 0;
    height: calc(100vh - 140px);
    background: var(--bg-primary);
    border: 1px solid var(--border-primary);
    border-radius: var(--radius-lg);
    overflow: hidden;
}

/* Left sidebar listing conversations */
.customer-sidebar {
    background: var(--bg-secondary);
    border-right: 1px solid var(--border-primary);
    display: flex;
    flex-direction: column;
    overflow-y: auto;
}

.sidebar-header {
    padding: var(--space-5);
    border-bottom: 1px solid var(--border-primary);
}

.sidebar-header h3 {
    font-size: var(--font-size-lg);
    font-weight: var(--font-semibold);
    color: var(--text-primary);
    margin-bottom: var(--space-2);
}

.sidebar-filters {
    display: flex;
    gap: var(--space-2);
}

.conversation-list {
    flex: 1;
    overflow-y: auto;
}

.conversation-item {
    padding: var(--space-4);
    border-bottom: 1px solid var(--border-primary);
    cursor: pointer;
    transition: background var(--transition-fast);
}

.conversation-item:hover {
    background: var(--bg-tertiary);
}

.conversation-item.active {
    background: var(--primary-600);
}

.conversation-item .name {
    font-weight: var(--font-semibold);
    color: var(--text-primary);
}

.conversation-item .preview {
    font-size: var(--font-size-xs);
    color: var(--text-tertiary);
}

/* Main chat section */
.chat-section {
    display: flex;
    flex-direction: column;
    background: var(--bg-primary);
}

.chat-header {
    padding: var(--space-5);
    border-bottom: 1px solid var(--border-primary);
}

.chat-header h3 {
    font-size: var(--font-size-lg);
    font-weight: var(--font-semibold);
    color: var(--text-primary);
}

.chat-header p {
    font-size: var(--font-size-sm);
    color: var(--text-secondary);
}

.chat-messages {
    flex: 1;
    padding: var(--space-5);
    overflow-y: auto;
    background: var(--bg-tertiary);
    display: flex;
    flex-direction: column;
    gap: var(--space-3);
}

.message {
    max-width: 75%;
    padding: var(--space-3) var(--space-4);
    border-radius: var(--radius-lg);
    font-size: var(--font-size-sm);
    line-height: 1.5;
    color: var(--text-primary);
}

.message.athlete {
    align-self: flex-start;
    background: var(--bg-surface);
}

.message.coach {
    align-self: flex-end;
    background: var(--primary-600);
}

.message.error {
    align-self: center;
    background: var(--error-50);
    border: 1px solid var(--error-200);
    color: var(--error-700);
    max-width: 90%;
}

.message.success {
    align-self: center;
    background: var(--success-50);
    border: 1px solid var(--success-200);
    color: var(--success-700);
    max-width: 90%;
}

.message .meta {
    display: block;
    font-size: var(--font-size-xs);
    color: var(--text-quaternary);
    margin-top: var(--space-1);
    text-align: right;
}

/* Composer with action toggles */
.chat-composer {
    display: flex;
    flex-direction: column;
    gap: var(--space-3);
    padding: var(--space-4);
    border-top: 1px solid var(--border-primary);
    background: var(--bg-secondary);
}

.composer-actions {
    display: flex;
    gap: var(--space-2);
    align-items: center;
    flex-wrap: wrap;
}

.action-toggle {
    display: flex;
    align-items: center;
    gap: var(--space-1);
    font-size: var(--font-size-xs);
    color: var(--text-secondary);
}

.action-toggle input[type="checkbox"] {
    margin: 0;
}

.composer-inputs {
    display: flex;
    align-items: center;
    gap: var(--space-2);
}

.composer-inputs select,
.composer-inputs input {
    background: var(--bg-tertiary);
    border: 1px solid var(--border-primary);
    color: var(--text-primary);
    padding: var(--space-2) var(--space-3);
    border-radius: var(--radius-md);
    font-size: var(--font-size-sm);
}

.composer-inputs input {
    flex: 1;
}

.composer-inputs button {
    background: var(--primary-500);
    color: white;
    border: none;
    padding: var(--space-3) var(--space-4);
    border-radius: var(--radius-md);
    font-size: var(--font-size-sm);
    cursor: pointer;
    transition: background var(--transition-fast);
}

.composer-inputs button:hover {
    background: var(--primary-600);
}

/* Right sidebar for highlights and to‑do */
.highlights-sidebar {
    background: var(--bg-secondary);
    border-left: 1px solid var(--border-primary);
    display: flex;
    flex-direction: column;
    overflow-y: auto;
}

.highlights-header {
    padding: var(--space-5);
    border-bottom: 1px solid var(--border-primary);
}

.highlights-header h3 {
    font-size: var(--font-size-lg);
    font-weight: var(--font-semibold);
    color: var(--text-primary);
    margin-bottom: var(--space-3);
}

.highlights-controls {
    display: flex;
    gap: var(--space-2);
    margin-bottom: var(--space-3);
}

.highlights-controls button {
    background: var(--primary-500);
    color: white;
    border: none;
    padding: var(--space-2) var(--space-3);
    border-radius: var(--radius-sm);
    font-size: var(--font-size-xs);
    cursor: pointer;
    transition: background var(--transition-fast);
}

.highlights-controls button:hover {
    background: var(--primary-600);
}

.highlights-controls button.secondary {
    background: var(--bg-tertiary);
    color: var(--text-primary);
    border: 1px solid var(--border-primary);
}

.highlights-filters {
    display: flex;
    gap: var(--space-2);
    margin-bottom: var(--space-3);
}

.highlights-filters select {
    background: var(--bg-tertiary);
    border: 1px solid var(--border-primary);
    color: var(--text-primary);
    padding: var(--space-1) var(--space-2);
    border-radius: var(--radius-sm);
    font-size: var(--font-size-xs);
}

.highlight-list,
.todo-list {
    padding: var(--space-4);
    display: flex;
    flex-direction: column;
    gap: var(--space-3);
}

.highlight-item {
    background: var(--bg-tertiary);
    border: 1px solid var(--border-primary);
    border-radius: var(--radius-md);
    padding: var(--space-3);
    font-size: var(--font-size-xs);
    color: var(--text-secondary);
    position: relative;
}

.highlight-item.suggested {
    border-left: 4px solid var(--warning-500);
    background: var(--warning-50);
}

.highlight-item.accepted {
    border-left: 4px solid var(--success-500);
}

.highlight-item.rejected {
    border-left: 4px solid var(--error-500);
    opacity: 0.6;
}

.highlight-item .highlight-text {
    margin-bottom: var(--space-2);
    color: var(--text-primary);
}

.highlight-item .highlight-meta {
    display: flex;
    justify-content: space-between;
    align-items: center;
    font-size: var(--font-size-xs);
    color: var(--text-tertiary);
}

.highlight-item .highlight-actions {
    display: flex;
    gap: var(--space-1);
    margin-top: var(--space-2);
}

.highlight-item .highlight-actions button {
    background: var(--bg-surface);
    border: 1px solid var(--border-primary);
    color: var(--text-secondary);
    padding: var(--space-1) var(--space-2);
    border-radius: var(--radius-sm);
    font-size: var(--font-size-xs);
    cursor: pointer;
    transition: all var(--transition-fast);
}

.highlight-item .highlight-actions button:hover {
    background: var(--primary-500);
    color: white;
}

.highlight-item .highlight-actions button.accept {
    background: var(--success-500);
    color: white;
}

.highlight-item .highlight-actions button.reject {
    background: var(--error-500);
    color: white;
}

.todo-item {
    background: var(--bg-tertiary);
    border: 1px solid var(--border-primary);
    border-radius: var(--radius-md);
    padding: var(--space-3);
    font-size: var(--font-size-xs);
    color: var(--text-secondary);
}

.todo-item.completed {
    text-decoration: line-through;
    opacity: 0.6;
}

@media (max-width: 1024px) {
    .communication-hub {
        grid-template-columns: 1fr 320px;
    }
    .customer-sidebar {
        display: none;
    }
}

@media (max-width: 768px) {
    .communication-hub {
        grid-template-columns: 1fr;
    }
    .highlights-sidebar {
        display: none;
    }
}
</style>
{% endblock %}

{% block content %}
<div class="communication-hub">
    <!-- Conversation list (left column) -->
    <aside class="customer-sidebar">
        <div class="sidebar-header">
            <h3>Athletes</h3>
            <div class="sidebar-filters">
                <select id="conversationPlatformFilter" class="filter-select">
                    <option value="all">All Platforms</option>
                    <option value="whatsapp">WhatsApp</option>
                    <option value="telegram">Telegram</option>
                    <option value="email">Email</option>
                    <option value="manual">Manual</option>
                </select>
            </div>
        </div>
        <div class="conversation-list" id="conversationList">
            <!-- Athletes will be loaded here -->
        </div>
    </aside>

    <!-- Main chat section (centre) -->
    <section class="chat-section">
        <div class="chat-header">
            <h3 id="chatAthleteName">Select an athlete</h3>
            <p id="chatAthleteStatus">Choose an athlete to start chatting</p>
        </div>
        <div class="chat-messages" id="messagesContainer">
            <!-- Messages will be inserted here dynamically -->
        </div>
        <div class="chat-composer">
            <div class="composer-actions">
                <label class="action-toggle">
                    <input type="checkbox" id="saveToHistory" checked>
                    Save to history
                </label>
                <label class="action-toggle">
                    <input type="checkbox" id="generateHighlights">
                    Generate highlights
                </label>
                <label class="action-toggle">
                    <input type="checkbox" id="suggestReply">
                    Suggest reply
                </label>
                <label class="action-toggle">
                    <input type="checkbox" id="maybeTodo">
                    Create To-Do
                </label>
            </div>
            <div class="composer-inputs">
                <select id="messagePlatform">
                    <option value="whatsapp">WhatsApp</option>
                    <option value="telegram">Telegram</option>
                    <option value="email">Email</option>
                    <option value="manual">Manual</option>
                </select>
                <input type="text" id="messageInput" placeholder="Type your message...">
                <button id="recordAudioBtn" title="Record audio"><i class="fa fa-microphone"></i></button>
                <button id="sendMessageBtn">Send</button>
            </div>
        </div>
    </section>

    <!-- Highlights and To‑Do list (right column) -->
    <aside class="highlights-sidebar">
        <div class="highlights-header">
            <h3>Highlights & To‑Do</h3>
            <div class="highlights-controls">
                <button id="generateHighlightsBtn">Generate (AI)</button>
                <button id="acceptAllBtn" class="secondary">Accept All</button>
                <button id="rejectAllBtn" class="secondary">Reject All</button>
            </div>
            <div class="highlights-filters">
                <select id="highlightStatusFilter">
                    <option value="all">All Status</option>
                    <option value="suggested">Suggested</option>
                    <option value="accepted">Accepted</option>
                    <option value="rejected">Rejected</option>
                </select>
                <select id="highlightSourceFilter">
                    <option value="all">All Sources</option>
                    <option value="ai">AI</option>
                    <option value="manual">Manual</option>
                </select>
            </div>
        </div>
        <div class="highlight-list" id="highlightList">
            <!-- Highlights will be inserted here dynamically -->
        </div>
        <div class="todo-list" id="todoList">
            <!-- To‑Do items will be inserted here dynamically -->
        </div>
    </aside>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Global state
let currentAthleteId = null;
let athletes = [];
let messages = {};
let highlights = {};
let todos = {};

// API base URL
const API_BASE = window.location.origin;

// Load athletes on page load
async function loadAthletes() {
    try {
        const response = await fetch(`${API_BASE}/api/athletes`);
        if (response.ok) {
            const data = await response.json();
            athletes = data.athletes || [];
            renderAthleteList();
        } else {
            console.error('Failed to load athletes:', response.status);
            showError('Failed to load athletes. Please refresh the page.');
        }
    } catch (error) {
        console.error('Error loading athletes:', error);
        showError('Error loading athletes. Please check your connection.');
    }
}

// Render athlete list
function renderAthleteList() {
    const list = document.getElementById('conversationList');
    list.innerHTML = '';
    
    if (athletes.length === 0) {
        list.innerHTML = `
            <div style="text-align: center; padding: var(--space-4); color: var(--text-tertiary);">
                <div>No athletes found</div>
                <div style="font-size: var(--font-size-xs); margin-top: var(--space-2);">
                    Add athletes from the Athletes page first
                </div>
            </div>
        `;
        return;
    }
    
    athletes.forEach(athlete => {
        const item = document.createElement('div');
        item.className = 'conversation-item';
        item.dataset.id = athlete.id;
        item.innerHTML = `
            <div class="name">${athlete.name}</div>
            <div class="preview">${athlete.sport || 'No sport'} • ${athlete.level || 'No level'}</div>
        `;
        item.addEventListener('click', () => selectAthlete(athlete.id));
        list.appendChild(item);
    });
}

// Select an athlete
async function selectAthlete(athleteId) {
    currentAthleteId = athleteId;
    
    // Highlight selected item
    document.querySelectorAll('.conversation-item').forEach(item => item.classList.remove('active'));
    const activeItem = document.querySelector(`.conversation-item[data-id="${athleteId}"]`);
    if (activeItem) activeItem.classList.add('active');
    
    // Update header
    const athlete = athletes.find(a => a.id === athleteId);
    document.getElementById('chatAthleteName').textContent = athlete.name;
    document.getElementById('chatAthleteStatus').textContent = `${athlete.sport} • ${athlete.level}`;
    
    // Load conversations and highlights
    await loadConversations(athleteId);
    await loadHighlights(athleteId);
    await loadTodos(athleteId);
}

// Load conversations for an athlete
async function loadConversations(athleteId) {
    try {
        const response = await fetch(`${API_BASE}/communication-hub/conversations/${athleteId}`);
        if (response.ok) {
            const data = await response.json();
            // For now, we'll just load the first conversation's messages
            if (data.conversations && data.conversations.length > 0) {
                await loadMessages(data.conversations[0].id);
            } else {
                renderMessages([]);
            }
        } else {
            renderMessages([]);
        }
    } catch (error) {
        console.error('Error loading conversations:', error);
        renderMessages([]);
    }
}

// Load messages for a conversation
async function loadMessages(conversationId) {
    try {
        const response = await fetch(`${API_BASE}/communication-hub/conversations/${conversationId}/messages`);
        if (response.ok) {
            const data = await response.json();
            renderMessages(data.messages || []);
        } else {
            renderMessages([]);
        }
    } catch (error) {
        console.error('Error loading messages:', error);
        renderMessages([]);
    }
}

// Render messages
function renderMessages(messageList) {
    const container = document.getElementById('messagesContainer');
    container.innerHTML = '';
    
    messageList.forEach(msg => {
        const div = document.createElement('div');
        div.className = `message ${msg.direction === 'in' ? 'athlete' : 'coach'}`;
        const content = msg.content_text || msg.transcription || '';
        const time = new Date(msg.created_at).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
        div.innerHTML = `${content}<span class="meta">${time}</span>`;
        container.appendChild(div);
    });
    
    container.scrollTop = container.scrollHeight;
}

// Load highlights for an athlete
async function loadHighlights(athleteId) {
    try {
        const statusFilter = document.getElementById('highlightStatusFilter').value;
        const sourceFilter = document.getElementById('highlightSourceFilter').value;
        
        const response = await fetch(`${API_BASE}/highlights/${athleteId}?status=${statusFilter}&source=${sourceFilter}`);
        if (response.ok) {
            const data = await response.json();
            highlights[athleteId] = data.highlights || [];
            renderHighlights(athleteId);
        } else {
            highlights[athleteId] = [];
            renderHighlights(athleteId);
        }
    } catch (error) {
        console.error('Error loading highlights:', error);
        highlights[athleteId] = [];
        renderHighlights(athleteId);
    }
}

// Render highlights
function renderHighlights(athleteId) {
    const container = document.getElementById('highlightList');
    container.innerHTML = '';
    
    const athleteHighlights = highlights[athleteId] || [];
    
    if (athleteHighlights.length === 0) {
        container.innerHTML = '<div style="text-align: center; color: var(--text-tertiary); padding: var(--space-4);">No highlights found</div>';
        return;
    }
    
    athleteHighlights.forEach(highlight => {
        const el = document.createElement('div');
        el.className = `highlight-item ${highlight.status}`;
        el.dataset.highlightId = highlight.id;
        
        el.innerHTML = `
            <div class="highlight-text">${highlight.text}</div>
            <div class="highlight-meta">
                <span>${highlight.category} • ${Math.round(highlight.score * 100)}%</span>
                <span>${highlight.source.toUpperCase()}</span>
            </div>
            ${highlight.status === 'suggested' ? `
                <div class="highlight-actions">
                    <button class="accept" onclick="acceptHighlight(${highlight.id})">Accept</button>
                    <button class="reject" onclick="rejectHighlight(${highlight.id})">Reject</button>
                    <button onclick="editHighlight(${highlight.id})">Edit</button>
                </div>
            ` : ''}
        `;
        
        container.appendChild(el);
    });
}

// Accept a highlight
async function acceptHighlight(highlightId) {
    try {
        const response = await fetch(`${API_BASE}/highlights/${highlightId}`, {
            method: 'PATCH',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                status: 'accepted',
                reviewed_by: 'coach'
            })
        });
        
        if (response.ok) {
            await loadHighlights(currentAthleteId);
        } else {
            console.error('Failed to accept highlight');
        }
    } catch (error) {
        console.error('Error accepting highlight:', error);
    }
}

// Reject a highlight
async function rejectHighlight(highlightId) {
    try {
        const response = await fetch(`${API_BASE}/highlights/${highlightId}`, {
            method: 'PATCH',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                status: 'rejected',
                reviewed_by: 'coach'
            })
        });
        
        if (response.ok) {
            await loadHighlights(currentAthleteId);
        } else {
            console.error('Failed to reject highlight');
        }
    } catch (error) {
        console.error('Error rejecting highlight:', error);
    }
}

// Edit a highlight
function editHighlight(highlightId) {
    const highlightElement = document.querySelector(`[data-highlight-id="${highlightId}"]`);
    const textElement = highlightElement.querySelector('.highlight-text');
    const currentText = textElement.textContent;
    
    const input = document.createElement('input');
    input.type = 'text';
    input.value = currentText;
    input.style.width = '100%';
    input.style.marginBottom = 'var(--space-2)';
    
    const saveButton = document.createElement('button');
    saveButton.textContent = 'Save';
    saveButton.className = 'accept';
    saveButton.onclick = async () => {
        try {
            const response = await fetch(`${API_BASE}/highlights/${highlightId}`, {
                method: 'PATCH',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    text: input.value,
                    status: 'accepted',
                    reviewed_by: 'coach'
                })
            });
            
            if (response.ok) {
                await loadHighlights(currentAthleteId);
            } else {
                console.error('Failed to update highlight');
            }
        } catch (error) {
            console.error('Error updating highlight:', error);
        }
    };
    
    textElement.innerHTML = '';
    textElement.appendChild(input);
    textElement.appendChild(saveButton);
    input.focus();
}

// Generate highlights for current athlete
async function generateHighlights() {
    if (!currentAthleteId) {
        alert('Please select an athlete first');
        return;
    }
    
    try {
        // First, create a test message to generate highlights for
        const messageData = {
            athlete_id: currentAthleteId,
            content_text: "Test message for highlight generation",
            source_channel: "manual",
            generate_highlights: true
        };
        
        const response = await fetch(`${API_BASE}/ingest/manual`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(messageData)
        });
        
        if (response.ok) {
            await loadHighlights(currentAthleteId);
        } else {
            console.error('Failed to generate highlights');
        }
    } catch (error) {
        console.error('Error generating highlights:', error);
    }
}

// Accept all suggested highlights
async function acceptAllHighlights() {
    if (!currentAthleteId) return;
    
    const suggestedHighlights = highlights[currentAthleteId]?.filter(h => h.status === 'suggested') || [];
    if (suggestedHighlights.length === 0) return;
    
    try {
        const response = await fetch(`${API_BASE}/highlights/bulk`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                highlight_ids: suggestedHighlights.map(h => h.id),
                status: 'accepted',
                reviewed_by: 'coach'
            })
        });
        
        if (response.ok) {
            await loadHighlights(currentAthleteId);
        } else {
            console.error('Failed to accept all highlights');
        }
    } catch (error) {
        console.error('Error accepting all highlights:', error);
    }
}

// Reject all suggested highlights
async function rejectAllHighlights() {
    if (!currentAthleteId) return;
    
    const suggestedHighlights = highlights[currentAthleteId]?.filter(h => h.status === 'suggested') || [];
    if (suggestedHighlights.length === 0) return;
    
    try {
        const response = await fetch(`${API_BASE}/highlights/bulk`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                highlight_ids: suggestedHighlights.map(h => h.id),
                status: 'rejected',
                reviewed_by: 'coach'
            })
        });
        
        if (response.ok) {
            await loadHighlights(currentAthleteId);
        } else {
            console.error('Failed to reject all highlights');
        }
    } catch (error) {
        console.error('Error rejecting all highlights:', error);
    }
}

// Load todos for an athlete
async function loadTodos(athleteId) {
    try {
        const response = await fetch(`${API_BASE}/athletes/${athleteId}/todos`);
        if (response.ok) {
            const data = await response.json();
            todos[athleteId] = data.todos || [];
            renderTodos(athleteId);
        } else {
            todos[athleteId] = [];
            renderTodos(athleteId);
        }
    } catch (error) {
        console.error('Error loading todos:', error);
        todos[athleteId] = [];
        renderTodos(athleteId);
    }
}

// Render todos
function renderTodos(athleteId) {
    const container = document.getElementById('todoList');
    container.innerHTML = '';
    
    const athleteTodos = todos[athleteId] || [];
    
    if (athleteTodos.length === 0) {
        container.innerHTML = '<div style="text-align: center; color: var(--text-tertiary); padding: var(--space-4);">No todos found</div>';
        return;
    }
    
    athleteTodos.forEach(todo => {
        const el = document.createElement('div');
        el.className = 'todo-item' + (todo.status === 'done' ? ' completed' : '');
        el.textContent = todo.title;
        container.appendChild(el);
    });
}

// Show error message
function showError(message) {
    const container = document.getElementById('messagesContainer');
    const errorDiv = document.createElement('div');
    errorDiv.className = 'message error';
    errorDiv.innerHTML = `<span style="color: var(--error-500);">⚠️ ${message}</span>`;
    container.appendChild(errorDiv);
    container.scrollTop = container.scrollHeight;
}

// Show success message
function showSuccess(message) {
    const container = document.getElementById('messagesContainer');
    const successDiv = document.createElement('div');
    successDiv.className = 'message success';
    successDiv.innerHTML = `<span style="color: var(--success-500);">✅ ${message}</span>`;
    container.appendChild(successDiv);
    container.scrollTop = container.scrollHeight;
}

// Send message with workflow actions
async function sendMessage() {
    if (!currentAthleteId) {
        showError('Please select an athlete first');
        return;
    }
    
    const input = document.getElementById('messageInput');
    const content = input.value.trim();
    if (!content) {
        showError('Please enter a message');
        return;
    }
    
    // Show sending indicator
    const sendBtn = document.getElementById('sendMessageBtn');
    const originalText = sendBtn.textContent;
    sendBtn.textContent = 'Sending...';
    sendBtn.disabled = true;
    
    const messageData = {
        athlete_id: currentAthleteId,
        content_text: content,
        source_channel: document.getElementById('messagePlatform').value,
        generate_highlights: document.getElementById('generateHighlights').checked,
        suggest_reply: document.getElementById('suggestReply').checked,
        maybe_todo: document.getElementById('maybeTodo').checked
    };
    
    try {
        const response = await fetch(`${API_BASE}/ingest/manual`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(messageData)
        });
        
        if (response.ok) {
            const result = await response.json();
            
            // Clear input
            input.value = '';
            
            // Show success message
            showSuccess('Message sent successfully!');
            
            // Reload highlights and todos
            await loadHighlights(currentAthleteId);
            await loadTodos(currentAthleteId);
            
            // Reload conversations to show new message
            await loadConversations(currentAthleteId);
            
            // Show what actions were performed
            const actions = result.result?.actions_performed || {};
            if (Object.keys(actions).length > 0) {
                const actionList = Object.keys(actions).join(', ');
                showSuccess(`Actions performed: ${actionList}`);
            }
        } else {
            const errorText = await response.text();
            console.error('Failed to send message:', errorText);
            showError('Failed to send message. Please try again.');
        }
    } catch (error) {
        console.error('Error sending message:', error);
        showError('Error sending message. Please check your connection.');
    } finally {
        // Restore button
        sendBtn.textContent = originalText;
        sendBtn.disabled = false;
    }
}

// Event listeners
document.addEventListener('DOMContentLoaded', () => {
    loadAthletes();
    
    // Send message button
    document.getElementById('sendMessageBtn').addEventListener('click', sendMessage);
    
    // Generate highlights button
    document.getElementById('generateHighlightsBtn').addEventListener('click', generateHighlights);
    
    // Accept all button
    document.getElementById('acceptAllBtn').addEventListener('click', acceptAllHighlights);
    
    // Reject all button
    document.getElementById('rejectAllBtn').addEventListener('click', rejectAllHighlights);
    
    // Filter changes
    document.getElementById('highlightStatusFilter').addEventListener('change', () => {
        if (currentAthleteId) loadHighlights(currentAthleteId);
    });
    
    document.getElementById('highlightSourceFilter').addEventListener('change', () => {
        if (currentAthleteId) loadHighlights(currentAthleteId);
    });
    
    // Enter key to send message
    document.getElementById('messageInput').addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
            sendMessage();
        }
    });
});
</script>
{% endblock %}