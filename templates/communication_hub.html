{% extends "base.html" %}

{% block title %}Elite Athletes â€¢ Communication Hub{% endblock %}
{% block page_title %}Communication Hub{% endblock %}
{% block page_subtitle %}Unified messaging center for all athlete communications{% endblock %}

{% block extra_css %}
<style>
    /* Communication Hub specific styles */
    .communication-hub {
        display: grid;
        grid-template-columns: 320px 1fr 380px;
        height: calc(100vh - 140px);
        gap: 0;
        background: var(--bg-primary);
    }

    .customer-sidebar {
        background: var(--bg-secondary);
        border-right: 1px solid var(--border-primary);
        display: flex;
        flex-direction: column;
        overflow: hidden;
    }

    .customer-header {
        padding: var(--space-6);
        border-bottom: 1px solid var(--border-primary);
    }

    .customer-profile {
        display: flex;
        align-items: center;
        gap: var(--space-3);
    }

    .customer-avatar {
        width: 48px;
        height: 48px;
        border-radius: 50%;
        background: linear-gradient(135deg, var(--primary-500), var(--secondary-500));
        color: white;
        font-weight: 600;
        font-size: 1.125rem;
        display: flex;
        align-items: center;
        justify-content: center;
        position: relative;
    }

    .status-indicator {
        position: absolute;
        bottom: 0;
        right: 0;
        width: 12px;
        height: 12px;
        border-radius: 50%;
        border: 2px solid var(--bg-secondary);
        animation: pulse 2s infinite;
    }

    .status-indicator.online {
        background: var(--online);
    }

    .status-indicator.away {
        background: var(--away);
    }

    .status-indicator.busy {
        background: var(--busy);
    }

    .status-indicator.offline {
        background: var(--offline);
    }

    @keyframes pulse {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.5; }
    }

    .customer-info h3 {
        font-size: 1.125rem;
        font-weight: 600;
        color: var(--text-primary);
        margin-bottom: var(--space-1);
    }

    .customer-status {
        color: var(--text-secondary);
        font-size: 0.875rem;
        display: flex;
        align-items: center;
        gap: var(--space-2);
    }

    .platform-indicators {
        display: flex;
        gap: var(--space-4);
        margin-top: var(--space-4);
    }

    .platform-status {
        display: flex;
        align-items: center;
        gap: var(--space-2);
        font-size: 0.875rem;
        color: var(--text-tertiary);
    }

    .platform-dot {
        width: 10px;
        height: 10px;
        border-radius: 50%;
    }

    .platform-status.whatsapp .platform-dot { background: var(--whatsapp); }
    .platform-status.telegram .platform-dot { background: var(--telegram); }
    .platform-status.email .platform-dot { background: var(--email); }
    .platform-status.sms .platform-dot { background: var(--sms); }
    .platform-status.phone .platform-dot { background: var(--phone); }

    .timeline-section {
        padding: var(--space-6);
        flex: 1;
        overflow-y: auto;
    }

    .timeline-header {
        display: flex;
        flex-direction: column;
        margin-bottom: var(--space-4);
    }

    .timeline-title {
        display: flex;
        align-items: center;
        gap: var(--space-2);
        font-weight: 600;
        margin-bottom: var(--space-2);
        color: var(--text-primary);
    }

    .timeline-filters {
        display: flex;
        flex-wrap: wrap;
        gap: var(--space-2);
    }

    .filter-btn {
        padding: 0.25rem 0.75rem;
        border-radius: var(--radius-md);
        border: 1px solid var(--border-primary);
        background: var(--bg-tertiary);
        color: var(--text-tertiary);
        font-size: 0.75rem;
        cursor: pointer;
        transition: all var(--transition-fast);
    }

    .filter-btn:hover {
        background: var(--primary-500);
        color: white;
        border-color: var(--primary-500);
    }

    .filter-btn.active {
        background: var(--primary-500);
        color: white;
        border-color: var(--primary-500);
    }

    .timeline {
        position: relative;
        padding-left: var(--space-6);
    }

    .timeline::before {
        content: '';
        position: absolute;
        left: 15px;
        top: 0;
        bottom: 0;
        width: 2px;
        background: var(--border-primary);
    }

    .timeline-item {
        position: relative;
        margin-bottom: var(--space-4);
        padding: var(--space-4);
        background: var(--bg-secondary);
        border-radius: var(--radius-lg);
        border: 1px solid var(--border-primary);
        cursor: pointer;
        transition: all var(--transition-fast);
    }

    .timeline-item:hover {
        background: var(--bg-tertiary);
        border-color: var(--primary-500);
    }

    .timeline-item::before {
        content: '';
        position: absolute;
        left: -23px;
        top: 20px;
        width: 12px;
        height: 12px;
        border-radius: 50%;
        background: var(--primary-500);
        border: 2px solid var(--bg-secondary);
    }

    .timeline-item.whatsapp::before { background: var(--whatsapp); }
    .timeline-item.telegram::before { background: var(--telegram); }
    .timeline-item.email::before { background: var(--email); }
    .timeline-item.sms::before { background: var(--sms); }
    .timeline-item.phone::before { background: var(--phone); }

    .timeline-item-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: var(--space-2);
    }

    .timeline-platform {
        display: flex;
        align-items: center;
        gap: var(--space-2);
        font-size: 0.75rem;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.05em;
    }

    .timeline-platform.whatsapp { color: var(--whatsapp); }
    .timeline-platform.telegram { color: var(--telegram); }
    .timeline-platform.email { color: var(--email); }
    .timeline-platform.sms { color: var(--sms); }
    .timeline-platform.phone { color: var(--phone); }

    .timeline-time {
        font-size: 0.75rem;
        color: var(--text-quaternary);
    }

    .timeline-content {
        color: var(--text-secondary);
        font-size: 0.875rem;
        line-height: 1.4;
    }

    .unified-chat {
        display: flex;
        flex-direction: column;
        background: var(--bg-chat);
        border-right: 1px solid var(--border-primary);
    }

    .chat-header {
        padding: var(--space-6);
        border-bottom: 1px solid var(--border-primary);
        display: flex;
        justify-content: space-between;
        align-items: center;
        background: var(--bg-secondary);
    }

    .chat-info {
        display: flex;
        align-items: center;
        gap: var(--space-4);
    }

    .omnichannel-icon {
        width: 48px;
        height: 48px;
        background: var(--primary-500);
        border-radius: var(--radius-lg);
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 1.25rem;
    }

    .chat-title {
        font-weight: 600;
        font-size: 1.125rem;
        color: var(--text-primary);
    }

    .chat-subtitle {
        color: var(--text-secondary);
        font-size: 0.875rem;
    }

    .chat-actions {
        display: flex;
        gap: var(--space-2);
    }

    .chat-action-btn {
        padding: var(--space-2) var(--space-3);
        border: 1px solid var(--border-primary);
        border-radius: var(--radius-md);
        background: var(--bg-tertiary);
        color: var(--text-secondary);
        font-size: 0.875rem;
        cursor: pointer;
        transition: all var(--transition-fast);
    }

    .chat-action-btn:hover {
        background: var(--primary-500);
        color: white;
        border-color: var(--primary-500);
    }

    .unified-messages {
        flex: 1;
        overflow-y: auto;
        padding: var(--space-6);
        display: flex;
        flex-direction: column;
        gap: var(--space-4);
    }

    .message {
        display: flex;
        align-items: flex-start;
        gap: var(--space-3);
        animation: slideIn 0.3s ease-out;
    }

    @keyframes slideIn {
        from { opacity: 0; transform: translateY(10px); }
        to { opacity: 1; transform: translateY(0); }
    }

    .message.whatsapp .message-bubble { background: #073b14; }
    .message.telegram .message-bubble { background: #021e36; }
    .message.email .message-bubble { background: #240404; }
    .message.sms .message-bubble { background: #0b1b38; }
    .message.phone .message-bubble { background: #032b06; }

    .message-content {
        display: flex;
        flex-direction: column;
        max-width: 70%;
    }

    .message-avatar {
        width: 32px;
        height: 32px;
        border-radius: 50%;
        background: linear-gradient(135deg, var(--primary-500), var(--secondary-500));
        color: white;
        font-weight: 600;
        font-size: 0.875rem;
        display: flex;
        align-items: center;
        justify-content: center;
        flex-shrink: 0;
    }

    .message-header {
        display: flex;
        align-items: center;
        gap: var(--space-2);
        margin-bottom: var(--space-1);
    }

    .message-sender {
        font-weight: 600;
        color: var(--text-primary);
        font-size: 0.875rem;
    }

    .message-platform {
        font-size: 0.75rem;
        padding: 0.125rem 0.375rem;
        border-radius: var(--radius-sm);
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.05em;
    }

    .message.whatsapp .message-platform { background: rgba(37, 211, 102, 0.2); color: var(--whatsapp); }
    .message.telegram .message-platform { background: rgba(0, 136, 204, 0.2); color: var(--telegram); }
    .message.email .message-platform { background: rgba(234, 67, 53, 0.2); color: var(--email); }
    .message.sms .message-platform { background: rgba(0, 122, 255, 0.2); color: var(--sms); }
    .message.phone .message-platform { background: rgba(52, 168, 83, 0.2); color: var(--phone); }

    .message-time {
        font-size: 0.75rem;
        color: var(--text-quaternary);
    }

    .message-bubble {
        padding: var(--space-3) var(--space-4);
        border-radius: var(--radius-lg);
        color: white;
        font-size: 0.875rem;
        line-height: 1.4;
    }

    .message-input-area {
        padding: var(--space-6);
        border-top: 1px solid var(--border-primary);
        background: var(--bg-secondary);
    }

    .message-input-container {
        display: flex;
        gap: var(--space-3);
        align-items: flex-end;
    }

    .message-input {
        flex: 1;
        padding: var(--space-3) var(--space-4);
        background: var(--bg-tertiary);
        border: 1px solid var(--border-primary);
        border-radius: var(--radius-lg);
        color: var(--text-primary);
        font-size: 0.875rem;
        resize: none;
        min-height: 44px;
        max-height: 120px;
        transition: border-color var(--transition-fast);
    }

    .message-input:focus {
        outline: none;
        border-color: var(--primary-500);
    }

    .send-btn {
        padding: var(--space-3) var(--space-4);
        background: var(--primary-500);
        color: white;
        border: none;
        border-radius: var(--radius-lg);
        font-weight: 600;
        cursor: pointer;
        transition: all var(--transition-fast);
        display: flex;
        align-items: center;
        gap: var(--space-2);
    }

    .send-btn:hover {
        background: var(--primary-600);
        transform: translateY(-1px);
    }

    .send-btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
        transform: none;
    }

    .highlights-sidebar {
        background: var(--bg-secondary);
        border-left: 1px solid var(--border-primary);
        display: flex;
        flex-direction: column;
        overflow: hidden;
    }

    .highlights-header {
        padding: var(--space-6);
        border-bottom: 1px solid var(--border-primary);
    }

    .highlights-title {
        display: flex;
        align-items: center;
        gap: var(--space-2);
        font-weight: 600;
        margin-bottom: var(--space-2);
        color: var(--text-primary);
    }

    .highlights-subtitle {
        font-size: 0.875rem;
        color: var(--text-secondary);
    }

    .highlights-tabs {
        display: flex;
        gap: var(--space-1);
        margin-top: var(--space-4);
    }

    .highlight-tab {
        padding: var(--space-2) var(--space-3);
        border: 1px solid var(--border-primary);
        border-radius: var(--radius-md);
        background: var(--bg-tertiary);
        color: var(--text-secondary);
        font-size: 0.75rem;
        cursor: pointer;
        transition: all var(--transition-fast);
    }

    .highlight-tab:hover {
        background: var(--primary-500);
        color: white;
        border-color: var(--primary-500);
    }

    .highlight-tab.active {
        background: var(--primary-500);
        color: white;
        border-color: var(--primary-500);
    }

    .highlights-content {
        flex: 1;
        overflow-y: auto;
        padding: var(--space-6);
    }

    .highlight-item {
        display: flex;
        align-items: flex-start;
        gap: var(--space-3);
        background: var(--bg-tertiary);
        padding: var(--space-4);
        border-radius: var(--radius-lg);
        border: 1px solid transparent;
        cursor: default;
        margin-bottom: var(--space-3);
        transition: all var(--transition-fast);
    }

    .highlight-item:hover {
        border-color: var(--primary-500);
        background: var(--bg-surface);
    }

    .highlight-bullet {
        width: 8px;
        height: 8px;
        border-radius: 50%;
        margin-top: 0.25rem;
        flex-shrink: 0;
    }

    .highlight-item.nutrition .highlight-bullet { background: var(--whatsapp); }
    .highlight-item.achievement .highlight-bullet { background: var(--telegram); }
    .highlight-item.question .highlight-bullet { background: var(--email); }
    .highlight-item.concern .highlight-bullet { background: var(--phone); }

    .highlight-content {
        flex: 1;
    }

    .highlight-text {
        color: var(--text-primary);
        font-size: 0.875rem;
        line-height: 1.4;
        margin-bottom: var(--space-2);
    }

    .highlight-meta {
        display: flex;
        align-items: center;
        gap: var(--space-3);
        font-size: 0.75rem;
        color: var(--text-quaternary);
    }

    .highlight-category {
        padding: 0.125rem 0.375rem;
        border-radius: var(--radius-sm);
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        font-size: 0.625rem;
    }

    .highlight-item.nutrition .highlight-category { background: rgba(37, 211, 102, 0.2); color: var(--whatsapp); }
    .highlight-item.achievement .highlight-category { background: rgba(0, 136, 204, 0.2); color: var(--telegram); }
    .highlight-item.question .highlight-category { background: rgba(234, 67, 53, 0.2); color: var(--email); }
    .highlight-item.concern .highlight-category { background: rgba(52, 168, 83, 0.2); color: var(--phone); }

    /* Responsive Design */
    @media (max-width: 1400px) {
        .communication-hub {
            grid-template-columns: 300px 1fr 350px;
        }
    }

    @media (max-width: 1200px) {
        .communication-hub {
            grid-template-columns: 280px 1fr 320px;
        }
    }

    @media (max-width: 1024px) {
        .communication-hub {
            grid-template-columns: 1fr 300px;
        }
        
        .customer-sidebar {
            display: none;
        }
    }

    @media (max-width: 768px) {
        .communication-hub {
            grid-template-columns: 1fr;
        }
        
        .highlights-sidebar {
            display: none;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="communication-hub">
    <!-- Customer Sidebar -->
    <div class="customer-sidebar">
        <div class="customer-header">
            <div class="customer-profile">
                <div class="customer-avatar">
                    <span>MJ</span>
                    <div class="status-indicator online"></div>
                </div>
                <div class="customer-info">
                    <h3>Michael Johnson</h3>
                    <div class="customer-status">
                        <span class="status-dot online"></span>
                        Online â€¢ Elite Athlete
                    </div>
                </div>
            </div>
            
            <div class="platform-indicators">
                <div class="platform-status whatsapp">
                    <div class="platform-dot"></div>
                    <span>WhatsApp</span>
                </div>
                <div class="platform-status telegram">
                    <div class="platform-dot"></div>
                    <span>Telegram</span>
                </div>
                <div class="platform-status email">
                    <div class="platform-dot"></div>
                    <span>Email</span>
                </div>
            </div>
        </div>
        
        <div class="timeline-section">
            <div class="timeline-header">
                <div class="timeline-title">
                    <i class="fas fa-history"></i>
                    All Conversations
                </div>
                <div class="timeline-filters">
                    <button class="filter-btn active" onclick="filterTimeline('all')">All</button>
                    <button class="filter-btn" onclick="filterTimeline('today')">Today</button>
                    <button class="filter-btn" onclick="filterTimeline('week')">Week</button>
                </div>
            </div>
            <div class="timeline" id="timelineList">
                <!-- Timeline items will be injected here -->
            </div>
        </div>
    </div>

    <!-- Unified Chat Area -->
    <div class="unified-chat">
        <div class="chat-header">
            <div class="chat-info">
                <div class="omnichannel-icon">
                    <i class="fas fa-comments"></i>
                </div>
                <div>
                    <div class="chat-title">Unified Conversation</div>
                    <div class="chat-subtitle">All platforms in one view</div>
                </div>
            </div>
            <div class="chat-actions">
                <button class="chat-action-btn">
                    <i class="fas fa-phone"></i>
                </button>
                <button class="chat-action-btn">
                    <i class="fas fa-video"></i>
                </button>
                <button class="chat-action-btn">
                    <i class="fas fa-ellipsis-v"></i>
                </button>
            </div>
        </div>
        
        <div class="unified-messages" id="messagesContainer">
            <!-- Messages will be injected here -->
        </div>
        
        <div class="message-input-area">
            <div class="message-input-container">
                <textarea 
                    class="message-input" 
                    placeholder="Type your message..." 
                    id="messageInput"
                    rows="1"
                    onkeydown="handleMessageKeydown(event)"
                ></textarea>
                <button class="send-btn" onclick="sendMessage()" id="sendBtn">
                    <i class="fas fa-paper-plane"></i>
                    Send
                </button>
            </div>
        </div>
    </div>

    <!-- Highlights Sidebar -->
    <div class="highlights-sidebar">
        <div class="highlights-header">
            <div class="highlights-title">
                <i class="fas fa-highlighter"></i>
                Conversation Highlights
            </div>
            <div class="highlights-subtitle">Auto-extracted & AI suggestions</div>
            <div class="highlights-tabs">
                <button class="highlight-tab active" onclick="switchHighlightTab('all')">All</button>
                <button class="highlight-tab" onclick="switchHighlightTab('ai')">AI</button>
                <button class="highlight-tab" onclick="switchHighlightTab('manual')">Manual</button>
            </div>
        </div>
        <div class="highlights-content" id="highlightsContent">
            <!-- Highlight items injected here -->
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Dynamic data loading
    let allMessages = [];
    let allHighlights = [];
    let currentAthlete = null;

    // Get athlete ID from URL parameters
    function getAthleteIdFromUrl() {
        const urlParams = new URLSearchParams(window.location.search);
        return urlParams.get('athlete');
    }

    // Load athlete data dynamically
    async function loadAthleteData(athleteId) {
        try {
            const response = await fetch(`/api/athletes/${athleteId}`);
            const athlete = await response.json();
            currentAthlete = athlete;
            updateAthleteProfile(athlete);
            
            // Load conversations for this athlete
            await loadAthleteConversations(athleteId);
            
            // Load highlights for this athlete
            await loadAthleteHighlights(athleteId);
            
        } catch (error) {
            console.error('Error loading athlete data:', error);
            showNotification('Error loading athlete data', 'error');
        }
    }

    // Update athlete profile display
    function updateAthleteProfile(athlete) {
        const avatar = document.querySelector('.customer-avatar span');
        const name = document.querySelector('.customer-info h3');
        const status = document.querySelector('.customer-status');
        
        if (avatar && name && status) {
            // Get initials from name
            const initials = athlete.name.split(' ').map(n => n[0]).join('');
            avatar.textContent = initials;
            name.textContent = athlete.name;
            status.innerHTML = `
                <span class="status-dot online"></span>
                Online â€¢ ${athlete.sport || 'Athlete'} ${athlete.level ? `â€¢ ${athlete.level}` : ''}
            `;
        }
    }

    // Load conversations for the athlete
    async function loadAthleteConversations(athleteId) {
        try {
            const response = await fetch(`/communication-hub/athletes/${athleteId}/conversations`);
            const data = await response.json();
            
            allMessages = data.conversations.map(conv => ({
                id: conv.id,
                sender: currentAthlete.name,
                platform: conv.source || 'manual',
                time: conv.timestamp,
                content: conv.transcription,
                role: 'athlete'
            }));
            
            updateMessages();
            updateTimeline();
            
        } catch (error) {
            console.error('Error loading conversations:', error);
            allMessages = [];
            updateMessages();
        }
    }

    // Load highlights for the athlete
    async function loadAthleteHighlights(athleteId) {
        try {
            const response = await fetch(`/api/athletes/${athleteId}/highlights`);
            const data = await response.json();
            
            allHighlights = data.highlights.map(highlight => ({
                id: highlight.id,
                text: highlight.highlight_text,
                category: highlight.category,
                timestamp: highlight.created_at,
                source: highlight.is_manual ? 'manual' : 'ai'
            }));
            
            updateAllHighlights();
            
        } catch (error) {
            console.error('Error loading highlights:', error);
            allHighlights = [];
            updateAllHighlights();
        }
    }

    // Initialize with dynamic data
    async function initializeData() {
        const athleteId = getAthleteIdFromUrl();
        
        if (athleteId) {
            await loadAthleteData(athleteId);
        } else {
            // Fallback to sample data if no athlete selected
            console.log('No athlete selected, using sample data');
            currentAthlete = {
                name: "Select an Athlete",
                sport: "Athlete",
                level: ""
            };
            updateAthleteProfile(currentAthlete);
        }
    }

    // Update messages display
    function updateMessages() {
        const container = document.getElementById('messagesContainer');
        container.innerHTML = '';
        
        allMessages.forEach(msg => {
            const messageElement = buildMessageElement(msg);
            container.appendChild(messageElement);
        });
        
        // Scroll to bottom
        container.scrollTop = container.scrollHeight;
    }

    // Build message element
    function buildMessageElement({ sender, platform, time, content, role }) {
        const wrapper = document.createElement('div');
        wrapper.className = `message ${platform.toLowerCase()}`;
        
        const avatar = document.createElement('div');
        avatar.className = 'message-avatar';
        avatar.innerText = sender[0];
        
        const contentWrapper = document.createElement('div');
        contentWrapper.className = 'message-content';
        
        const header = document.createElement('div');
        header.className = 'message-header';
        
        const senderSpan = document.createElement('span');
        senderSpan.className = 'message-sender';
        senderSpan.innerText = sender;
        
        const platformDiv = document.createElement('div');
        platformDiv.className = `message-platform ${platform.toLowerCase()}`;
        platformDiv.innerText = platform;
        
        const timeSpan = document.createElement('span');
        timeSpan.className = 'message-time';
        timeSpan.innerText = new Date(time).toLocaleTimeString();
        
        header.appendChild(senderSpan);
        header.appendChild(platformDiv);
        header.appendChild(timeSpan);
        
        const bubble = document.createElement('div');
        bubble.className = 'message-bubble';
        bubble.innerText = content;
        
        contentWrapper.appendChild(header);
        contentWrapper.appendChild(bubble);
        
        wrapper.appendChild(avatar);
        wrapper.appendChild(contentWrapper);
        
        return wrapper;
    }

    // Send message function
    async function sendMessage() {
        const input = document.getElementById('messageInput');
        const content = input.value.trim();
        
        if (!content) return;
        
        if (!currentAthlete || !currentAthlete.id) {
            showNotification('Please select an athlete first', 'error');
            return;
        }
        
        // Disable send button while sending
        const sendBtn = document.getElementById('sendBtn');
        const originalText = sendBtn.innerHTML;
        sendBtn.innerHTML = '<div class="loading-spinner"></div> Sending...';
        sendBtn.disabled = true;
        
        try {
            // Send message via API
            const formData = new FormData();
            formData.append('athlete_id', currentAthlete.id);
            formData.append('message', content);
            formData.append('platform', 'auto'); // Auto-select best available platform
            
            const response = await fetch('/communication-hub/send-message', {
                method: 'POST',
                body: formData
            });
            
            const result = await response.json();
            
            if (result.status === 'sent' || result.status === 'saved') {
                // Add message to local display
                const newMessage = {
                    id: Date.now(),
                    sender: "Coach",
                    platform: "manual",
                    time: new Date().toISOString(),
                    content: content,
                    role: "coach"
                };
                
                allMessages.push(newMessage);
                updateMessages();
                updateTimeline();
                
                input.value = '';
                input.style.height = 'auto';
                
                showNotification(result.message, 'success');
            } else {
                throw new Error(result.message || 'Failed to send message');
            }
            
        } catch (error) {
            console.error('Error sending message:', error);
            showNotification('Error sending message: ' + error.message, 'error');
        } finally {
            sendBtn.innerHTML = originalText;
            sendBtn.disabled = false;
        }
    }

    // Handle message input keydown
    function handleMessageKeydown(event) {
        if (event.key === 'Enter' && !event.shiftKey) {
            event.preventDefault();
            sendMessage();
        }
        
        // Auto-resize textarea
        const textarea = event.target;
        textarea.style.height = 'auto';
        textarea.style.height = Math.min(textarea.scrollHeight, 120) + 'px';
    }

    // Update timeline
    function updateTimeline() {
        const timeline = document.getElementById('timelineList');
        timeline.innerHTML = '';
        
        // Group messages by date
        const groupedMessages = groupMessagesByDate(allMessages);
        
        Object.keys(groupedMessages).forEach(date => {
            const messages = groupedMessages[date];
            const item = document.createElement('div');
            item.className = 'timeline-item';
            item.onclick = () => scrollToDate(date);
            
            const header = document.createElement('div');
            header.className = 'timeline-item-header';
            
            const platformDiv = document.createElement('div');
            platformDiv.className = `timeline-platform ${messages[0].platform.toLowerCase()}`;
            platformDiv.innerHTML = `<i class="fas ${getPlatformIcon(messages[0].platform)}"></i><span>${messages[0].platform}</span>`;
            
            const timeDiv = document.createElement('div');
            timeDiv.className = 'timeline-time';
            timeDiv.innerText = new Date(date).toLocaleDateString();
            
            header.appendChild(platformDiv);
            header.appendChild(timeDiv);
            
            const content = document.createElement('div');
            content.className = 'timeline-content';
            content.innerText = messages[0].content.substring(0, 100) + (messages[0].content.length > 100 ? '...' : '');
            
            item.appendChild(header);
            item.appendChild(content);
            timeline.appendChild(item);
        });
    }

    // Group messages by date
    function groupMessagesByDate(messages) {
        const grouped = {};
        messages.forEach(msg => {
            const date = new Date(msg.time).toDateString();
            if (!grouped[date]) {
                grouped[date] = [];
            }
            grouped[date].push(msg);
        });
        return grouped;
    }

    // Get platform icon
    function getPlatformIcon(platform) {
        const icons = {
            'whatsapp': 'fab fa-whatsapp',
            'telegram': 'fab fa-telegram',
            'email': 'fas fa-envelope',
            'sms': 'fas fa-sms',
            'phone': 'fas fa-phone'
        };
        return icons[platform.toLowerCase()] || 'fas fa-comment';
    }

    // Update highlights
    function updateAllHighlights() {
        const container = document.getElementById('highlightsContent');
        container.innerHTML = '';
        
        if (allHighlights.length === 0) {
            container.innerHTML = '<p style="color: var(--text-secondary); text-align: center; padding: 2rem;">No highlights yet. Start a conversation to see AI-generated highlights.</p>';
            return;
        }
        
        allHighlights.forEach(h => {
            const item = document.createElement('div');
            item.className = `highlight-item ${h.category || 'general'}`;
            
            const bullet = document.createElement('div');
            bullet.className = 'highlight-bullet';
            
            const contentDiv = document.createElement('div');
            contentDiv.className = 'highlight-content';
            
            const textDiv = document.createElement('div');
            textDiv.className = 'highlight-text';
            textDiv.innerText = h.text;
            
            const metaDiv = document.createElement('div');
            metaDiv.className = 'highlight-meta';
            
            const categorySpan = document.createElement('span');
            categorySpan.className = 'highlight-category';
            categorySpan.innerText = h.category || 'general';
            
            const timeSpan = document.createElement('span');
            timeSpan.innerText = new Date(h.timestamp).toLocaleTimeString();
            
            const sourceSpan = document.createElement('span');
            sourceSpan.innerText = h.source === 'ai' ? 'AI Generated' : 'Manual';
            
            metaDiv.appendChild(categorySpan);
            metaDiv.appendChild(timeSpan);
            metaDiv.appendChild(sourceSpan);
            
            contentDiv.appendChild(textDiv);
            contentDiv.appendChild(metaDiv);
            
            item.appendChild(bullet);
            item.appendChild(contentDiv);
            container.appendChild(item);
        });
    }

    // Placeholder filter function; currently no filtering logic implemented
    function filterTimeline(filter) {
        console.log('Timeline filter clicked:', filter);
    }

    // Highlight tab switching (UI only)
    function switchHighlightTab(tab) {
        document.querySelectorAll('.highlight-tab').forEach(tabBtn => {
            tabBtn.classList.remove('active');
        });
        event.target.classList.add('active');
        console.log('Switched to', tab, 'highlights');
    }

    // Scroll to date (placeholder)
    function scrollToDate(date) {
        console.log('Scrolling to date:', date);
    }

    // Notification function
    function showNotification(message, type = 'info') {
        // Create notification element
        const notification = document.createElement('div');
        notification.className = `notification ${type}`;
        
        notification.innerHTML = `
            <div style="display: flex; align-items: center; gap: var(--space-3);">
                <div style="font-size: 1.25rem;">
                    <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : 'info-circle'}"></i>
                </div>
                <div>
                    <div style="font-weight: 600; font-size: 0.875rem;">${message}</div>
                </div>
            </div>
        `;
        
        document.body.appendChild(notification);
        
        // Show notification
        setTimeout(() => notification.classList.add('show'), 100);
        
        // Remove after 3 seconds
        setTimeout(() => {
            notification.classList.remove('show');
            setTimeout(() => notification.remove(), 300);
        }, 3000);
    }

    // Initialize
    document.addEventListener('DOMContentLoaded', function() {
        initializeData();
    });
</script>
{% endblock %}