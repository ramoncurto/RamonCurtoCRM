{% extends "improved_base.html" %}

{% block title %}Elite Athletes • History{% endblock %}
{% block page_title %}Conversation History{% endblock %}
{% block page_subtitle %}Browse and manage past communications{% endblock %}

{% block extra_css %}
<style>
.history-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: var(--space-6);
}
.filters-section {
    display: flex;
    flex-wrap: wrap;
    gap: var(--space-4);
    align-items: center;
}
.filter-group {
    display: flex;
    align-items: center;
    gap: var(--space-2);
}
.filter-label {
    font-size: var(--font-size-sm);
    color: var(--text-secondary);
    font-weight: var(--font-medium);
}
.filter-select {
    padding: var(--space-2) var(--space-3);
    background: var(--bg-tertiary);
    border: 1px solid var(--border-primary);
    border-radius: var(--radius-md);
    color: var(--text-primary);
    font-size: var(--font-size-sm);
    min-width: 140px;
}
.search-box {
    position: relative;
    max-width: 280px;
}
.search-input {
    width: 100%;
    padding: var(--space-2) var(--space-3) var(--space-2) var(--space-8);
    background: var(--bg-tertiary);
    border: 1px solid var(--border-primary);
    border-radius: var(--radius-md);
    color: var(--text-primary);
    font-size: var(--font-size-sm);
}
.search-icon {
    position: absolute;
    left: var(--space-3);
    top: 50%;
    transform: translateY(-50%);
    color: var(--text-quaternary);
}
.history-stats {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: var(--space-4);
    margin-bottom: var(--space-6);
}
.stat-card {
    background: var(--bg-secondary);
    border: 1px solid var(--border-primary);
    border-radius: var(--radius-lg);
    padding: var(--space-4);
    text-align: center;
}
.stat-number {
    font-size: var(--font-size-3xl);
    font-weight: var(--font-bold);
    color: var(--text-primary);
    margin-bottom: var(--space-1);
}
.stat-label {
    color: var(--text-secondary);
    font-size: var(--font-size-sm);
}
.history-table {
    background: var(--bg-secondary);
    border: 1px solid var(--border-primary);
    border-radius: var(--radius-lg);
    overflow: hidden;
}
.table-header {
    background: var(--bg-tertiary);
    padding: var(--space-4) var(--space-6);
    border-bottom: 1px solid var(--border-primary);
}
.table-title {
    font-size: var(--font-size-lg);
    font-weight: var(--font-semibold);
    color: var(--text-primary);
}
.table-content {
    max-height: 560px;
    overflow-y: auto;
}
.history-item {
    display: flex;
    align-items: center;
    padding: var(--space-4) var(--space-6);
    border-bottom: 1px solid var(--border-primary);
    transition: background var(--transition-fast);
    cursor: pointer;
}
.history-item:hover {
    background: var(--bg-tertiary);
}
.history-item:last-child {
    border-bottom: none;
}
.history-icon {
    width: 36px;
    height: 36px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: var(--font-size-sm);
    color: white;
    margin-right: var(--space-4);
}
.history-icon.whatsapp { background: var(--whatsapp); }
.history-icon.telegram { background: var(--telegram); }
.history-icon.email { background: var(--email); }
.history-icon.sms { background: var(--sms); }
.history-icon.phone { background: var(--phone); }
.history-content {
    flex: 1;
    min-width: 0;
}
.history-title {
    font-weight: var(--font-semibold);
    color: var(--text-primary);
    margin-bottom: var(--space-1);
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}
.history-subtitle {
    color: var(--text-secondary);
    font-size: var(--font-size-sm);
    margin-bottom: var(--space-1);
}
.history-meta {
    display: flex;
    gap: var(--space-3);
    font-size: var(--font-size-xs);
    color: var(--text-quaternary);
}
.history-actions {
    display: flex;
    gap: var(--space-2);
    margin-left: var(--space-4);
}
.action-btn {
    padding: var(--space-2) var(--space-3);
    border: 1px solid var(--border-primary);
    border-radius: var(--radius-md);
    background: var(--bg-tertiary);
    color: var(--text-secondary);
    font-size: var(--font-size-xs);
    cursor: pointer;
    transition: background var(--transition-fast);
}
.action-btn:hover {
    background: var(--primary-500);
    color: white;
    border-color: var(--primary-500);
}
</style>
{% endblock %}

{% block content %}
<div class="history-header">
    <div class="filters-section">
        <div class="filter-group">
            <span class="filter-label">Platform:</span>
            <select id="platformFilter" class="filter-select">
                <option value="all">All</option>
                <option value="whatsapp">WhatsApp</option>
                <option value="telegram">Telegram</option>
                <option value="email">Email</option>
                <option value="sms">SMS</option>
                <option value="phone">Phone</option>
            </select>
        </div>
        <div class="filter-group">
            <span class="filter-label">Date:</span>
            <select id="dateFilter" class="filter-select">
                <option value="all">All time</option>
                <option value="today">Today</option>
                <option value="week">This week</option>
                <option value="month">This month</option>
            </select>
        </div>
    </div>
    <div class="search-box">
        <input type="text" id="historySearch" class="search-input" placeholder="Search conversations...">
        <i class="fa fa-search search-icon"></i>
    </div>
</div>
<div class="history-stats">
    <div class="stat-card">
        <div class="stat-number" id="totalConversations">0</div>
        <div class="stat-label">Total Conversations</div>
    </div>
    <div class="stat-card">
        <div class="stat-number" id="totalHighlights">0</div>
        <div class="stat-label">Highlights</div>
    </div>
    <div class="stat-card">
        <div class="stat-number" id="todoCount">0</div>
        <div class="stat-label">To‑Do Items</div>
    </div>
</div>
<div class="history-table">
    <div class="table-header">
        <h3 class="table-title">Conversation Records</h3>
    </div>
    <div class="table-content" id="historyList">
        <!-- History items will be injected here -->
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Sample history data for demonstration
let historyData = [
    {
        id: 1,
        platform: 'whatsapp',
        title: 'Sarah Johnson via WhatsApp',
        subtitle: '“I have some feedback about today’s workout”',
        date: '2025-07-27',
        time: '14:32',
        highlights: 2
    },
    {
        id: 2,
        platform: 'telegram',
        title: 'Michael Chen via Telegram',
        subtitle: '“Can we reschedule our session?”',
        date: '2025-07-26',
        time: '09:15',
        highlights: 1
    },
    {
        id: 3,
        platform: 'email',
        title: 'Emma Rodriguez via Email',
        subtitle: 'Weekly progress report',
        date: '2025-07-25',
        time: '18:47',
        highlights: 0
    }
];

function filterHistory() {
    const platform = document.getElementById('platformFilter').value;
    const dateFilter = document.getElementById('dateFilter').value;
    const query = document.getElementById('historySearch').value.toLowerCase();
    const filtered = historyData.filter(item => {
        const matchesPlatform = platform === 'all' || item.platform === platform;
        const matchesQuery = item.title.toLowerCase().includes(query) || item.subtitle.toLowerCase().includes(query);
        // Simple date filtering (in a real app you would parse dates)
        return matchesPlatform && matchesQuery;
    });
    renderHistoryList(filtered);
}

function renderHistoryList(list) {
    const container = document.getElementById('historyList');
    container.innerHTML = '';
    list.forEach(item => {
        const elem = document.createElement('div');
        elem.className = 'history-item';
        elem.innerHTML = `
            <span class="history-icon ${item.platform}"><i class="fa fa-${item.platform === 'email' ? 'envelope' : item.platform === 'phone' ? 'phone' : 'comment'}"></i></span>
            <div class="history-content">
                <p class="history-title">${item.title}</p>
                <p class="history-subtitle">${item.subtitle}</p>
                <div class="history-meta">
                    <span>${item.date}</span><span>${item.time}</span><span>${item.highlights} highlights</span>
                </div>
            </div>
            <div class="history-actions">
                <button class="action-btn" onclick="viewConversation(${item.id})"><i class="fa fa-eye"></i> View</button>
                <button class="action-btn" onclick="deleteConversation(${item.id})"><i class="fa fa-trash"></i> Delete</button>
            </div>
        `;
        container.appendChild(elem);
    });
    // Update stats
    document.getElementById('totalConversations').textContent = list.length;
}

function viewConversation(id) {
    // Navigate to communication hub with selected conversation
    window.location.href = `/communication-hub?conversation=${id}`;
}

function deleteConversation(id) {
    if (confirm('Are you sure you want to delete this conversation?')) {
        historyData = historyData.filter(item => item.id !== id);
        filterHistory();
    }
}

// Initialize
document.addEventListener('DOMContentLoaded', () => {
    document.getElementById('platformFilter').addEventListener('change', filterHistory);
    document.getElementById('dateFilter').addEventListener('change', filterHistory);
    document.getElementById('historySearch').addEventListener('input', filterHistory);
    renderHistoryList(historyData);
});
</script>
{% endblock %}